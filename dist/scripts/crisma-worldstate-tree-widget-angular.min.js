angular.module("de.cismet.crisma.widgets.worldstateTreeWidget",["de.cismet.crisma.widgets.worldstateTreeWidget.directives","de.cismet.crisma.widgets.worldstateTreeWidget.controllers"]),angular.module("de.cismet.crisma.widgets.worldstateTreeWidget.controllers",["de.cismet.cids.rest.collidngNames.Nodes","de.cismet.crisma.ICMM.Worldstates"]).controller("MainCtrl",["$scope","de.cismet.collidingNameService.Nodes",function(a,b){"use strict";a.activeItem={},a.isWorldstateIcon=!1,a.treeOptions={checkboxClass:"glyphicon glyphicon-unchecked",folderIconClosed:"icon-folder-close.png",folderIconOpen:"icon-folder-open.png",leafIcon:"icon-file.png",imagePath:"./images/",multiSelection:!0},a.switchIcon=function(){a.isWorldstateIcon?(a.treeOptions.folderIconClosed="icon-folder-close.png",a.treeOptions.folderIconOpen="icon-folder-open.png",a.treeOptions.leafIcon="icon-file.png"):(a.treeOptions.folderIconClosed="icon-world.png",a.treeOptions.folderIconOpen="icon-world.png",a.treeOptions.leafIcon="icon-world.png"),a.isWorldstateIcon=!a.isWorldstateIcon},a.switchTreeMode=function(){a.treeOptions.multiSelection=!a.treeOptions.multiSelection},a.treeSelection=[],b.query(function(b){a.nodes=b})}]),angular.module("de.cismet.crisma.widgets.worldstateTreeWidget.directives",["de.cismet.commons.angular.angularTools"]).directive("catalogueTree",["de.cismet.commons.angular.angularTools.AngularTools",function(a){"use strict";return{templateUrl:"templates/catalogue-tree.html",restrict:"E",link:function(b,c){var d,e,f,g,h=[],i=!1,j={container:"dynatree-container",node:"dynatree-node",folder:"dynatree-folder",empty:"dynatree-empty",vline:"dynatree-vline",expander:"dynatree-expander",connector:"dynatree-connector",checkbox:"dynatree-checkbox",nodeIcon:"dynatree-icon",title:"dynatree-title",noConnector:"dynatree-no-connector",nodeError:"dynatree-statusnode-error",nodeWait:"dynatree-statusnode-wait",hidden:"dynatree-hidden",combinedExpanderPrefix:"dynatree-exp-",combinedIconPrefix:"dynatree-ico-",hasChildren:"dynatree-has-children",active:"dynatree-active",selected:"dynatree-selected",expanded:"dynatree-expanded",lazy:"dynatree-lazy",focused:"dynatree-focused",partsel:"dynatree-partsel",lastsib:"dynatree-lastsib"},k=function(){var a,b={};for(a in j)j.hasOwnProperty(a)&&(b[a]=j[a]);return b},l=function(a,c){var d;return d=a?b.options.leafIcon||"":c?b.options.folderIconOpen||"":b.options.folderIconClosed||""},m=function(a){var b,c;return b=l(a.isLeaf,!1,a),c={title:a.name,isFolder:!a.isLeaf,isLazy:!a.isLeaf,cidsNode:a,icon:b}},n=function(a,b){var d,f,g,h,i,j,l,m=k();a?(g=!0,d=function(a,b){"title"===a.getEventTargetType(b)&&a.toggleSelect()},f=function(a,b){return 32===b.which?(a.toggleSelect(),!1):void 0}):(m.selected="tree-select",i=!1,j=function(a,b){var c,d;if("expander"===a.getEventTargetType(b)&&a.expand(!a.isExpanded()),"checkbox"===a.getEventTargetType(b))return!0;if(!b.ctrlKey)for(d=a.tree.getSelectedNodes(),c=0;c<d.length;c++)d[c].select(!1);return a.activate(),a.toggleSelect(),!1},d=function(a,b){return"title"===a.getEventTargetType(b)?(a.expand(!a.isExpanded()),!1):void 0},l=function(a){var b,d,e=c.dynatree("getTree"),f=e.getSelectedNodes(!1);for(b=0;b<f.length;b++)d=f[b],d.toggleSelect();return a.activate(),a.select(!0),!0}),b?(c.dynatree("option","checkbox",g||!1),c.dynatree("option","onDblClick",d||null),c.dynatree("option","onClick",j||null),c.dynatree("option","onFocus",l||null),c.dynatree("option","onKeydown",f||null),c.dynatree("option","clickFolderMode",h||3),c.dynatree("option","classNames",m),c.dynatree("option","autoFocus",i||!0)):(e.checkbox=g||!1,e.onDblClick=d||null,e.onKeydown=f||null,e.clickFolderMode=h||3,e.classNames=m,e.autoFocus=i||!0,e.onClick=j||null,e.onFocus=l||null)};if(f=b.$watchCollection("nodes",function(a,d){var e,f,h,i,j,k;if(a!==d)for(b.selectedNodes&&b.selectedNodes.length>0&&(g=!0),h=c.dynatree("getRoot"),h.visit(function(a){return b.activeNode&&a.data.cidsNode.key===b.activeNode.key?(a.deactivate(),!0):void 0},!1),h.removeChildren(),e=0;e<a.length;e++)if(i=a[e],j=m(i),k=h.addChild(j),g)for(f=0;e<b.selectedNodes.length;f++)if(b.selectedNodes[f].key===j.cidsNode.key){k.toggleSelect();break}}),b.$watch("selectedNodes",function(){var a,d,e,f,h,i;if(h=function(a){return a.data.cidsNode.key===d.key?(a.select(),f=!0,!0):void 0},i=function(a){return a.isSelected()?(a.select(!1),!0):void 0},b.selectedNodes&&b.selectedNodes.length>0?g=!0:(g=!1,c.dynatree("getRoot").visit(i,!1)),e=[],b.selectedNodes)for(a=0;a<b.selectedNodes.length;a++)d=b.selectedNodes[a],f=!1,e[d.key]?console.error("The worldstate "+d.key+" is contained multiple times in the selectedNodes property bound to the worldstateTreeWidget. Multiple items are ignored by the worldstateTreeWidget but should be avoided"):(e[d.key]=d,c.dynatree("getRoot").visit(h,!1)),f||e[d.key]||console.log("Could not select node"+b.activeNode.key+" because it is not contained in the tree. Eventually it is a childNode not yet loaded. It is selected as soon it is loaded however")},!0),b.$watch("activeNode",function(){var a;a=!1,c.dynatree("getRoot").visit(function(c){return b.activeNode&&c.data.cidsNode.key===b.activeNode.key?(c.activate(),a=!0,!0):void 0},!1),a||console.log("Could not find the activeNode "+b.activeNode.key+" in the tree. Eventually it is a childNode not yet loaded.")},!0),b.$watch("options",function(a,d){var e,f,g,h,j,k=!1;if(i){for(h in b.options)if(e=a[h],f=d[h],g=e!==f,j=e&&!f,g||j)switch(h){case"checkboxClass":c.dynatree("option","classNames.checkbox",e);break;case"checkboxEnabled":c.dynatree("option","checkbox",e);break;case"imagePath":c.dynatree("option","imagePath",e);break;case"multiSelection":n(e,!0);break;case"folderIconClosed":k=!0;break;case"folderIconOpen":k=!0;break;case"leafIcon":k=!0;break;case"clickFolderMode":c.dynatree("option","clickFolderMode",e||3)}}else i=!0;c.dynatree("getRoot").visit(function(a){k&&(a.data.icon=l(a.data.cidsNode.isLeaf,a.isExpanded(),a.data.cidsNode)),a.render()},!1)},!0),e={selectMode:2,children:h,classNames:j,onActivate:function(c){b.activeNode=c.data.cidsNode,a.safeApply(b)},onSelect:function(c,d){var e,f,g;return f=d.data.cidsNode,g=!1,c?(b.selectedNodes.forEach(function(a){a.key===f.key&&(g=!0)}),g||b.selectedNodes.push(f)):(e=-1,b.selectedNodes.forEach(function(a,b){a.key===f.key&&(e=b)}),e>=0&&b.selectedNodes.splice(e,1)),a.safeApply(b),!1},onExpand:function(a,b){return b.data.icon=l(b.data.cidsNode.isLeaf,b.isExpanded(),b.data.cidsNode),b.render(),!0},onLazyRead:function(a){var c,d,e,f;c=a.data.cidsNode,a.data.addClass="dynatree-loading",a.render(),d=function(d){var h,i,j;for(h=0;h<d.length;h++)if(j=d[h],j.key=c.key+"."+j.objectKey.substring(j.objectKey.lastIndexOf("/")+1,j.objectKey.length),e=m(j),f=a.addChild(e),g)for(i=0;i<b.selectedNodes.length;i++)if(b.selectedNodes[i].key===e.cidsNode.key){f.toggleSelect();break}a.data.addClass="",a.setLazyNodeStatus(DTNodeStatus_Ok),a.data.icon=l(a.data.cidsNode.isLeaf,a.isExpanded(),a.data.cidsNode),a.render()},c.getChildren(d)}},b.options)for(var o in b.options)switch(d=b.options[o],o){case"checkboxClass":e.classNames.checkbox=d;break;case"checkboxEnabled":e.checkbox=d||!1;break;case"imagePath":e.imagePath=d;break;case"multiSelection":n(d);break;case"clickFolderMode":e.clickFolderMode=d}c.dynatree(e)},replace:!0,scope:{nodes:"=",selectedNodes:"=selection",selectedW:"=selection",activeNode:"=?",options:"=?"}}}]),angular.module("de.cismet.crisma.widgets.worldstateTreeWidget.controllers").controller("de.cismet.crisma.widgets.worldstateTreeWidget.WorldstateTreeCtrl",["$scope","de.cismet.collidingNameService.Nodes","de.cismet.crisma.ICMM.Worldstates","$q",function(a,b,c,d){"use strict";function e(a){var b;return b=d.defer(),c.get({wsId:a.id,level:100,field:"parentworldstate,id",deduplicate:!0},function(a){var c;for(c=a.id;a.parentworldstate;)a=a.parentworldstate,c+="."+a.id;c=""+c,b.resolve(c.split(".").reverse().join("."))}),b.promise}function f(a){var c=d.defer();return e(a).then(function(a){b.get({nodeId:b.utils.getRequestIdForNodeKey(a)},function(a){c.resolve(a)})}),c.promise}var g,h;g=!1,h=!1,a.activeNode={},a.$watch("activeNode",function(b,d){var e;return g?void(g=!1):void(angular.equals(b,d)||(e=a.activeNode.objectKey,e=e.substring(e.lastIndexOf("/")+1,e.length),c.get({wsId:e,level:2},function(b){a.activeWorldstate=b})))}),a.$watch("activeWorldstate",function(b,c){angular.equals(b,c)||f(a.activeWorldstate).then(function(b){g=!0,a.activeNode=b})}),a.selectedNodes=[],a.$watch("selectedNodes",function(b,d){var e,f,g;if(h&&angular.equals(b,d))return void(h=!1);if(!angular.equals(b,d))if(0===b.length)a.selectedWorldstates.splice(0,a.selectedWorldstates.length);else for(f=[],e=0;e<a.selectedNodes.length;e++)g=a.selectedNodes[e].objectKey,g=g.substring(g.lastIndexOf("/")+1,g.length),c.get({wsId:g,level:2},function(b){f.push(b),f.length===a.selectedNodes.length&&(a.selectedWorldstates=f)})},!0),a.$watch("selectedWorldstates",function(b,c){var e,g;if(!angular.equals(b,c)){for(g=[],e=0;e<a.selectedWorldstates.length;e++)g.push(f(a.selectedWorldstates[e]));d.all(g).then(function(b){angular.equals(b,a.selectedNodes)||(h=!0),a.selectedNodes=b})}},!0),c.query({level:2,filter:"parentworldstate:null"},function(b){var c,e;if(b&&b.length>0){for(e=[],c=0;c<b.length;c++)e.push(f(b[c]));d.all(e).then(function(b){a.topLevelNodes=b})}})}]),angular.module("de.cismet.crisma.widgets.worldstateTreeWidget.directives").directive("worldstateTree",[function(){"use strict";return{templateUrl:"templates/worldstate-tree.html",restrict:"E",scope:{selectedWorldstates:"=",activeWorldstate:"=",options:"="},controller:"de.cismet.crisma.widgets.worldstateTreeWidget.WorldstateTreeCtrl"}}]),angular.module("de.cismet.crisma.widgets.worldstateTreeWidget.directives").run(["$templateCache",function(a){"use strict";a.put("templates/catalogue-tree.html",'<div id="tree">\n\n</div>'),a.put("templates/worldstate-tree.html",'<div>\n    <catalogue-tree class="catalagoue-tree" options="options" nodes="topLevelNodes" selection="selectedNodes" active-node="activeNode"></catalogue-tree>\n</div>')}]);